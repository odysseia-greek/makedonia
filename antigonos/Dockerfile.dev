# syntax=docker/dockerfile:1.6
ARG GO_VERSION=1.24
FROM golang:${GO_VERSION}-alpine AS build
WORKDIR /src

# Bring in the whole repo so we have go.work AND filippos
COPY . .

# Make sure weâ€™re in the service
WORKDIR /src/antigonos

# Ensure local filippos is used (no git, no proxy)
RUN go mod edit -replace=github.com/odysseia-greek/makedonia/filippos=../filippos
RUN go mod tidy

# (Optional) generate protos using root config
# RUN buf generate --config ../buf.yaml

# Build
ARG TARGETOS
ARG TARGETARCH
ARG project_name=antigonos
ENV CGO_ENABLED=0
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
    go build -ldflags="-s -w" -o /out/antigonos

FROM gcr.io/distroless/base-debian12
WORKDIR /app
ARG project_name=antigonos
COPY --from=build /out/${project_name} .
EXPOSE 8080
ENTRYPOINT ["/app/antigonos"]